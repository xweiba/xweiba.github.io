{"title":"Nginx 相关","uid":"5b3fd36ba58de8c4f5cd292f46984b8d","slug":"Nginx 相关","date":"2021-05-18T05:07:23.000Z","updated":"2025-04-30T08:11:18.862Z","comments":true,"path":"api/articles/Nginx 相关.json","keywords":null,"cover":null,"content":"<h2 id=\"直接返回文件内容\"><a href=\"#直接返回文件内容\" class=\"headerlink\" title=\"直接返回文件内容\"></a>直接返回文件内容</h2><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span><span class=\"regexp\"> ^~</span> /get_json_file&#123;</span><br><span class=\"line\">\t<span class=\"attribute\">default_type</span> application/json;</span><br><span class=\"line\">\t<span class=\"attribute\">add_header</span> Content-Type <span class=\"string\">&#x27;application/json; charset=utf-8&#x27;</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">alias</span> D:/resouces/code/java/test.json;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">location</span> <span class=\"regexp\">~ ^/get_json</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span> application/json;</span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"string\">&#x27;&#123;&quot;status&quot;:&quot;success&quot;,&quot;result&quot;:&quot;hello world!&quot;&#125;&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h2><ol>\n<li>配置 <code>conf/nginx.conf</code></li>\n</ol>\n<ul>\n<li>默认轮询 添加下列配置 <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http&#123;</span><br><span class=\"line\">    ....</span><br><span class=\"line\">    upstream tomcats &#123;</span><br><span class=\"line\">        server 127.0.0.1:8080</span><br><span class=\"line\">        server 127.0.0.1:9080</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://tomcats;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"错误记录\"><a href=\"#错误记录\" class=\"headerlink\" title=\"错误记录\"></a>错误记录</h2><p>重载配置 <code>./nginx -c ../conf/nginx.conf -s reload </code>, 报错: <code>nginx: [emerg] unknown directive</code>. </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">原因是因为因为nginx.conf配置被windows下的记事本编辑过, 编码变成了UTF-8+BOOM, nginx 报错.</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"reload-不生效\"><a href=\"#reload-不生效\" class=\"headerlink\" title=\"reload 不生效\"></a>reload 不生效</h2><p>浏览器端禁用缓存, 可发起新连接</p>\n<h2 id=\"http-转发至-https\"><a href=\"#http-转发至-https\" class=\"headerlink\" title=\"http 转发至 https\"></a>http 转发至 https</h2><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\"># 添加dns解析地址, nginx在proxy_pass转发时如果使用变量, 当此变量是域名时有很大几率会出现无法解析导致502问题</span></span><br><span class=\"line\">    <span class=\"comment\"># 错误日志为: no resolver defined to resolve ***</span></span><br><span class=\"line\">    <span class=\"attribute\">resolver</span> <span class=\"number\">8.8.8.8</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 443 </span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> xxx.com;</span><br><span class=\"line\">    <span class=\"attribute\">ssl</span> <span class=\"literal\">on</span>;   <span class=\"comment\">#设置为on启用SSL功能。</span></span><br><span class=\"line\">    <span class=\"attribute\">root</span> html;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate</span> cert/xxx.pem;   <span class=\"comment\">#将domain name.pem替换成您证书的文件名。</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate_key</span> cert/xxx.key;   <span class=\"comment\">#将domain name.key替换成您证书的密钥文件名。</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_session_timeout</span> <span class=\"number\">5m</span>;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  <span class=\"comment\">#使用此加密套件。</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_protocols</span> TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;   <span class=\"comment\">#使用该协议进行配置。</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_prefer_server_ciphers</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">location</span> = / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$http_host</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_redirect</span>     <span class=\"literal\">off</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span>         http://xxx/xxx/;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span>   Host             <span class=\"variable\">$host</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span>   X-Real-IP        <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span>   X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">        <span class=\"attribute\">client_max_body_size</span>    <span class=\"number\">1000m</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">service</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>  xxx.xxx.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"comment\"># GET 请求走301重定向, 非GET请求使用proxy_pass</span></span><br><span class=\"line\">        <span class=\"attribute\">if</span> (<span class=\"variable\">$request_method</span> <span class=\"regexp\">~ ^(POST|DELETE|OPTIONS)$)</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\"># 注意使用变量转发时一定要添加resolver配置</span></span><br><span class=\"line\">            <span class=\"attribute\">proxy_pass</span> https://<span class=\"variable\">$host</span>;</span><br><span class=\"line\">            <span class=\"attribute\">break</span> ;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)$</span>   https://<span class=\"variable\">$host</span><span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","text":"直接返回文件内容12345678910location ^~ /get_json_file{ default_type application/json; ad...","permalink":"/post/Nginx 相关","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[{"name":"Nginx","slug":"Nginx","count":1,"path":"api/categories/Nginx.json"}],"tags":[{"name":"Nginx","slug":"Nginx","count":1,"path":"api/tags/Nginx.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9\"><span class=\"toc-text\">直接返回文件内容</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1\"><span class=\"toc-text\">负载均衡</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95\"><span class=\"toc-text\">错误记录</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#reload-%E4%B8%8D%E7%94%9F%E6%95%88\"><span class=\"toc-text\">reload 不生效</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#http-%E8%BD%AC%E5%8F%91%E8%87%B3-https\"><span class=\"toc-text\">http 转发至 https</span></a></li></ol>","author":{"name":"Weiba","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/24520686?v=4","link":"/","description":"啊 又忘了更新了！","socials":{"github":"https://github.com/xweiba","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"Web-通过DragDropTouch适配移动端drop事件","uid":"7439aff8f53103a2ebd62b031bb6dedb","slug":"Web-通过DragDropTouch适配移动端drop事件","date":"2021-06-10T05:43:38.000Z","updated":"2025-04-30T08:11:18.865Z","comments":true,"path":"api/articles/Web-通过DragDropTouch适配移动端drop事件.json","keywords":null,"cover":null,"text":"DragDropTouch-Github 最近碰到一个bug,移动dom的drag事件在手机端没有反应, 查了一下drag是鼠标的相关api, 而手机端只有to...","permalink":"/post/Web-通过DragDropTouch适配移动端drop事件","photos":[],"count_time":{"symbolsCount":"12k","symbolsTime":"11 mins."},"categories":[{"name":"Web","slug":"Web","count":2,"path":"api/categories/Web.json"}],"tags":[{"name":"Web","slug":"Web","count":2,"path":"api/tags/Web.json"},{"name":"移动端","slug":"移动端","count":1,"path":"api/tags/移动端.json"},{"name":"适配","slug":"适配","count":1,"path":"api/tags/适配.json"}],"author":{"name":"Weiba","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/24520686?v=4","link":"/","description":"啊 又忘了更新了！","socials":{"github":"https://github.com/xweiba","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"vim 编辑器快捷键","uid":"9b0c0b539f3413401920f77d831fd931","slug":"vim 编辑器快捷键","date":"2021-04-26T05:08:44.000Z","updated":"2025-04-30T08:11:18.900Z","comments":true,"path":"api/articles/vim 编辑器快捷键.json","keywords":null,"cover":null,"text":"vim可以直接编辑jar等压缩包内容: vim xx.jar 再选择压缩包内配置文件修改. 常用命令 文本替换: 命令模式 : 下: %s/prepare-le...","permalink":"/post/vim 编辑器快捷键","photos":[],"count_time":{"symbolsCount":186,"symbolsTime":"1 mins."},"categories":[{"name":"Vim","slug":"Vim","count":1,"path":"api/categories/Vim.json"}],"tags":[{"name":"Vim","slug":"Vim","count":1,"path":"api/tags/Vim.json"},{"name":"常用","slug":"常用","count":1,"path":"api/tags/常用.json"}],"author":{"name":"Weiba","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/24520686?v=4","link":"/","description":"啊 又忘了更新了！","socials":{"github":"https://github.com/xweiba","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}